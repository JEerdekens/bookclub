{"ast":null,"code":"import React,{useState,useEffect}from\"react\";import{useNavigate}from\"react-router-dom\";import{auth,db}from\"../firebase\";import{doc,setDoc,getDoc,getDocs,collection,query,where}from\"firebase/firestore\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function ChooseUsername(){const[username,setUsername]=useState(\"\");const[error,setError]=useState(\"\");const[checking,setChecking]=useState(false);const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);const navigate=useNavigate();useEffect(()=>{const unsubscribe=auth.onAuthStateChanged(async currentUser=>{var _currentUser$provider;if(!currentUser){navigate(\"/\");return;}await currentUser.reload();// Ensure latest profile info\nsetUser(currentUser);const userDoc=await getDoc(doc(db,\"users\",currentUser.uid));if(userDoc.exists()){navigate(\"/home\");}else if(((_currentUser$provider=currentUser.providerData[0])===null||_currentUser$provider===void 0?void 0:_currentUser$provider.providerId)===\"google.com\"){var _currentUser$displayN;const googleName=(_currentUser$displayN=currentUser.displayName)===null||_currentUser$displayN===void 0?void 0:_currentUser$displayN.trim().toLowerCase();const isUnique=await checkUsernameUnique(googleName);const finalName=isUnique?googleName:\"\".concat(googleName).concat(Date.now());try{await setDoc(doc(db,\"users\",currentUser.uid),{username:finalName,email:currentUser.email,createdAt:new Date()});try{await currentUser.updateProfile({displayName:finalName});await currentUser.reload();}catch(profileErr){console.warn(\"Profile update failed:\",profileErr);// Optional: show a softer message or ignore\n}navigate(\"/home\");}catch(err){console.error(\"Error auto-assigning Google username:\",err);setError(\"Something went wrong while saving your username.\");}}else{setLoading(false);// Show manual form\n}});return()=>unsubscribe();},[navigate]);const checkUsernameUnique=async name=>{const q=query(collection(db,\"users\"),where(\"username\",\"==\",name));const snapshot=await getDocs(q);return snapshot.empty;};const handleSubmit=async e=>{e.preventDefault();setError(\"\");setChecking(true);const trimmed=username.trim().toLowerCase();if(!trimmed||trimmed.length<3){setError(\"Username must be at least 3 characters.\");setChecking(false);return;}const isUnique=await checkUsernameUnique(trimmed);if(!isUnique){setError(\"That username is already taken.\");setChecking(false);return;}try{await setDoc(doc(db,\"users\",user.uid),{username:trimmed,email:user.email,createdAt:new Date()});try{await user.updateProfile({displayName:trimmed});await user.reload();}catch(profileErr){console.warn(\"Profile update failed:\",profileErr);// Optional: show a softer message or ignore\n}navigate(\"/home\");}catch(err){console.error(\"Error saving username:\",err);setError(\"Something went wrong while saving your username.\");}finally{setChecking(false);}};if(loading||!user){return/*#__PURE__*/_jsx(\"div\",{className:\"text-center mt-5\",children:\"Loading...\"});}return/*#__PURE__*/_jsxs(\"div\",{className:\"container mt-5 text-center\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"mb-4\",children:\"\\uD83D\\uDC4B Welcome!\"}),/*#__PURE__*/_jsx(\"p\",{className:\"lead\",children:\"What should we call you?\"}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,className:\"mt-4\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"form-control mb-3\",placeholder:\"Choose a username\",value:username,onChange:e=>setUsername(e.target.value),disabled:checking}),error&&/*#__PURE__*/_jsx(\"p\",{className:\"text-danger\",children:error}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"btn btn-bd-primary w-100\",disabled:checking,children:checking?\"Checking...\":\"Continue\"})]})]});}export default ChooseUsername;","map":{"version":3,"names":["React","useState","useEffect","useNavigate","auth","db","doc","setDoc","getDoc","getDocs","collection","query","where","jsx","_jsx","jsxs","_jsxs","ChooseUsername","username","setUsername","error","setError","checking","setChecking","user","setUser","loading","setLoading","navigate","unsubscribe","onAuthStateChanged","currentUser","_currentUser$provider","reload","userDoc","uid","exists","providerData","providerId","_currentUser$displayN","googleName","displayName","trim","toLowerCase","isUnique","checkUsernameUnique","finalName","concat","Date","now","email","createdAt","updateProfile","profileErr","console","warn","err","name","q","snapshot","empty","handleSubmit","e","preventDefault","trimmed","length","className","children","onSubmit","type","placeholder","value","onChange","target","disabled"],"sources":["/Users/julineeerdekens/Desktop/bookclub/src/pages/ChooseUsername.js"],"sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { auth, db } from \"../firebase\";\nimport {\n  doc,\n  setDoc,\n  getDoc,\n  getDocs,\n  collection,\n  query,\n  where\n} from \"firebase/firestore\";\n\nfunction ChooseUsername() {\n  const [username, setUsername] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [checking, setChecking] = useState(false);\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {\n      if (!currentUser) {\n        navigate(\"/\");\n        return;\n      }\n\n      await currentUser.reload(); // Ensure latest profile info\n      setUser(currentUser);\n\n      const userDoc = await getDoc(doc(db, \"users\", currentUser.uid));\n\n      if (userDoc.exists()) {\n        navigate(\"/home\");\n      } else if (currentUser.providerData[0]?.providerId === \"google.com\") {\n        const googleName = currentUser.displayName?.trim().toLowerCase();\n\n        const isUnique = await checkUsernameUnique(googleName);\n        const finalName = isUnique ? googleName : `${googleName}${Date.now()}`;\n\n        try {\n          await setDoc(doc(db, \"users\", currentUser.uid), {\n            username: finalName,\n            email: currentUser.email,\n            createdAt: new Date()\n          });\n\n          try {\n            await currentUser.updateProfile({ displayName: finalName });\n            await currentUser.reload();\n          } catch (profileErr) {\n            console.warn(\"Profile update failed:\", profileErr);\n            // Optional: show a softer message or ignore\n          }\n\n          navigate(\"/home\");\n        } catch (err) {\n          console.error(\"Error auto-assigning Google username:\", err);\n          setError(\"Something went wrong while saving your username.\");\n        }\n      } else {\n        setLoading(false); // Show manual form\n      }\n    });\n\n    return () => unsubscribe();\n  }, [navigate]);\n\n  const checkUsernameUnique = async (name) => {\n    const q = query(collection(db, \"users\"), where(\"username\", \"==\", name));\n    const snapshot = await getDocs(q);\n    return snapshot.empty;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setError(\"\");\n    setChecking(true);\n\n    const trimmed = username.trim().toLowerCase();\n    if (!trimmed || trimmed.length < 3) {\n      setError(\"Username must be at least 3 characters.\");\n      setChecking(false);\n      return;\n    }\n\n    const isUnique = await checkUsernameUnique(trimmed);\n    if (!isUnique) {\n      setError(\"That username is already taken.\");\n      setChecking(false);\n      return;\n    }\n\n    try {\n      await setDoc(doc(db, \"users\", user.uid), {\n        username: trimmed,\n        email: user.email,\n        createdAt: new Date()\n      });\n\n      try {\n        await user.updateProfile({ displayName: trimmed });\n        await user.reload();\n      } catch (profileErr) {\n        console.warn(\"Profile update failed:\", profileErr);\n        // Optional: show a softer message or ignore\n      }\n\n      navigate(\"/home\");\n    } catch (err) {\n      console.error(\"Error saving username:\", err);\n      setError(\"Something went wrong while saving your username.\");\n    } finally {\n      setChecking(false);\n    }\n  };\n\n  if (loading || !user) {\n    return <div className=\"text-center mt-5\">Loading...</div>;\n  }\n\n  return (\n    <div className=\"container mt-5 text-center\">\n      <h2 className=\"mb-4\">ðŸ‘‹ Welcome!</h2>\n      <p className=\"lead\">What should we call you?</p>\n      <form onSubmit={handleSubmit} className=\"mt-4\">\n        <input\n          type=\"text\"\n          className=\"form-control mb-3\"\n          placeholder=\"Choose a username\"\n          value={username}\n          onChange={(e) => setUsername(e.target.value)}\n          disabled={checking}\n        />\n        {error && <p className=\"text-danger\">{error}</p>}\n        <button type=\"submit\" className=\"btn btn-bd-primary w-100\" disabled={checking}>\n          {checking ? \"Checking...\" : \"Continue\"}\n        </button>\n      </form>\n    </div>\n  );\n}\n\nexport default ChooseUsername;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}